---
title: "Final Submition"
output: pdf_document
date: "2024-08-20"
---

```{r}
library(tidyverse)
library(ggplot2)
genes <- read.csv("QBS103_GSE157103_genes.csv")
matrix <- read.csv("QBS103_GSE157103_series_matrix.csv")
matrix <- matrix %>% rename('procalcitonin.ng.ml.' = 'procalcitonin.ng.ml..')
```
Generate a table formatted in LaTeX of summary statistics for all the covariates you looked at and 2 additional continuous (3 total) and 1 additional categorical variable (3 total). (5 pts)
```{r}
### Define the item we need to control
selected_item <- c("age", "ferritin.ng.ml.", "procalcitonin.ng.ml.", "sex", "disease_status" , "icu_status" )
numeric_item <- c("age", "ferritin.ng.ml.", "procalcitonin.ng.ml.")
category_item <- c("sex", "disease_status" , "icu_status")
continous_item <- c("age", "ferritin.ng.ml.", "procalcitonin.ng.ml.")

table_generate <- function(matrix, selected_item){
  selected_item <- unlist(selected_item, numeric_item)
  selected_matrix <- matrix[,c('participant_id', selected_item)]
  for(item in numeric_item){
  selected_matrix[[item]] = as.numeric(selected_matrix[[item]])    
  }
  return(selected_matrix)
}

selected_table <- table_generate(matrix, selected_item)

summary_disease <- selected_table %>%
  group_by(sex, disease_status) %>%
  summarise(
    Count = n(),
    Percentage = round(100 * n() / nrow(selected_table), 1),
    .groups = 'drop'
  )

summary_icu <- selected_table %>%
  group_by(sex, icu_status) %>%
  summarise(
    Count = n(),
    Percentage = round(100 * n() / nrow(selected_table), 1),
    .groups = 'drop'
  )

summary_table <- selected_table %>%
  select(c(continous_item, 'sex'))%>%
  group_by(sex)%>%
  summarise(
    across(where(is.numeric), mean, na.rm = TRUE)
  )

```
selected_table %>%
  select(category_item)%>%
  group_by(sex)%>%
  summarise(
    occupation = n(),
    occupation_percent = (occupation / nrow(selected_table)) * 100,
  )

selected_table %>%
  select(c(continous_item, 'sex'))%>%
  group_by(sex)%>%
  summarise(
    across(where(is.numeric), mean, na.rm = TRUE)
  )

```{r}
library(table1)
library(dplyr)
# data preprocessing
# dropped a few cases where age is "89>" and ":"
matrix_filtered <- matrix %>%
  mutate(age = as.numeric(age)) %>%  # Convert 'age' to numeric 
  filter(!is.na(age) & age == as.integer(age))  # Filter to keep only integer ages 

matrix_filtered <- matrix_filtered %>%
  filter(sex != " unknown")

matrix_filtered$sex <-
  factor(matrix_filtered$sex, levels=c(' female',' male'),
         labels = c('Female','Male'))
matrix_filtered$mechanical_ventilation <-
  factor(matrix_filtered$mechanical_ventilation, levels = c(' yes',' no'), labels = c("Present", "Absent"))
label(matrix_filtered$sex)<- "Sex"
label(matrix_filtered$mechanical_ventilation)       <- "Mechanincal Ventilation"
label(matrix_filtered$age)       <- "Age"
label(matrix_filtered$hospital.free_days_post_45_day_followup)       <- "45 Days Followup Post Hospital"
label(matrix_filtered$ventilator.free_days)       <- "Ventilator Free Days"

# Generate the table with customized text color
table1(~ factor(mechanical_ventilation) + factor(sex) 
       + age + hospital.free_days_post_45_day_followup + ventilator.free_days 
      | disease_status, 
       data = matrix_filtered)
```


```{r}
plot_create <- function(genes, matrix, gene){
  genes_long <- genes %>%
    filter(X==gene) %>%
    gather(key = "participant_id")
  genes_long <- genes_long[-1,]

  plot_data <- merge(matrix, genes_long, by = "participant_id")
  plot_data$value <- as.numeric(as.character(plot_data$value))
  
  
  frequency_plot <-
    ggplot(plot_data, aes(x=value)) + 
    geom_histogram(binwidth=1, fill="#c8a2c8", color="#d9d9d9") + 
    ggtitle(paste("Histogram of Values of ", gene)) + 
    xlab("Value") + 
    ylab("Frequency")
  
  continuous_plot <-
    ggplot(plot_data, aes(x=age, y=value)) +
    geom_point(aes(color=age)) + 
    scale_color_gradient(low="#1E3D59", high="#F5C518") +
    ggtitle(paste("Scatterplot of ", gene, " gene vs. Age")) +
    xlab("age") +
    ylab("Value") +
    theme_minimal()
  
  categorical_plot <-
    ggplot(plot_data, aes(x = icu_status, y = value, fill = sex)) +
    geom_boxplot(notch = TRUE) +
    ggtitle(paste("Gene Value of ", gene," by icu status and sex") )+
    xlab("icu status") +
    ylab("Gene Value") +
    theme_minimal()
  
  return (list(frequency_plot, continuous_plot, categorical_plot))
}
```


```{r}
plots = plot_create(genes, selected_table, "AAMP")
print(plots)
```

```{r}
library(corrplot)
library(pheatmap)

gene_select = c("AAGAB", "AAMP", "AATF", "ABCA1", "ABCA2", "ABCA7", "ABCC5", "ABCB10", "ABCG1", "ABCE1", "ABCF1", "ABCF3", "ABHD10")

annotation <- data.frame(
  participant_id = factor(matrix$participant_id),
  sex = factor(matrix$sex),
  status = factor(matrix$icu_status)
)
rownames(annotation) <- annotation[,1]
annotation <- annotation[,-1]


gene_selected_data <- genes%>%
  filter(X %in% gene_select)
rownames(gene_selected_data) <- gene_selected_data[,1]
gene_selected_data <- gene_selected_data[,-1]

annotation_color <- list(
  status = c(' yes' = 'aquamarine4',
             ' no' = 'deepskyblue4'),
  sex = c(' female' = '#ff69b4',
          ' male' = '#1f77b4',
          ' unknown'= '#6a0dad')
)
pheatmap(gene_selected_data,
         cluster_rows = T,
         cluster_cols = T,
         annotation_col = annotation,
         annotation_colors = annotation_color,
         show_colnames = FALSE)
```

```{r}
levels(annotation$sex)
```

